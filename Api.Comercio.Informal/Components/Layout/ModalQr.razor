@using QRCoder
@using System.Drawing
@using System.IO
@inject IJSRuntime JSRuntime

@if (Mostrar)
{
    <style>
        @@media print {
            /* 1. Ocultamos visualmente todo el cuerpo, pero mantenemos el espacio */
            body {
                visibility: hidden !important;
                background-color: white !important;
            }
            /* 2. Forzamos a ocultar cualquier ventana modal de Bootstrap extra */
            .modal-header, .modal-footer, .btn-close {
                display: none !important;
            }
            /* 3. ESTRATEGIA DE SUPERPOSICIÓN:
                               Sacamos el área del QR del flujo normal y lo pegamos a la hoja */
            #areaImpresionQR {
                visibility: visible !important;
                display: block !important;
                position: fixed !important; /* Clave: Fijo respecto a la hoja */
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                margin: 0 !important;
                padding: 20px !important;
                background-color: white !important; /* Fondo blanco para tapar todo */
                z-index: 999999 !important; /* Asegurar que esté hasta arriba */
                /* Centrado del contenido en la hoja */
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: flex-start !important; /* Empezar desde arriba */
            }
                /* Aseguramos que todos los hijos (imagen, textos) sean visibles */
                #areaImpresionQR * {
                    visibility: visible !important;
                }
        }
    </style>

    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-qr-code me-2"></i> Código de Identidad
                    </h5>
                    <button type="button" class="btn-close" @onclick="Cerrar"></button>
                </div>

                <div class="modal-body text-center p-4" id="areaImpresionQR">

                    @if (!string.IsNullOrEmpty(ImagenQrBase64))
                    {
                        <center>
                            <div class="border p-3 d-inline-block rounded mb-3 bg-white">
                                <img src="@ImagenQrBase64" alt="QR Matricula" style="width: 250px; height: 250px; max-width: 100%;" />
                            </div>

                            <h2 class="fw-bold text-dark mb-1" style="font-size: 2rem;">@Matricula</h2>
                            <h4 class="text-muted text-uppercase mb-3">@NombreContribuyente</h4>

                            @* <div class="mt-4 border-top pt-2" style="width: 80%;">
                            <p class="small text-muted mb-0">H. Ayuntamiento de Tierra Blanca</p>
                            <p class="small text-muted">Dirección de Comercio</p>
                        </div> *@

                        </center>
                    }
                    else
                    {
                        <div class="spinner-border text-secondary" role="status"></div>
                    }

                </div>

                <div class="modal-footer bg-light">
                    <button type="button" class="btn official-btn-outline-secondary" @onclick="Cerrar">Cerrar</button>
                    <button type="button" class="btn official-btn-primary" @onclick="Imprimir">
                        <i class="bi bi-printer-fill me-2"></i> Imprimir
                    </button>
                </div>

            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Mostrar { get; set; }
    [Parameter] public EventCallback<bool> MostrarChanged { get; set; }

    [Parameter] public string Matricula { get; set; } = "";
    [Parameter] public string NombreContribuyente { get; set; } = "";

    private string ImagenQrBase64 = "";

    protected override void OnParametersSet()
    {
        if (Mostrar && !string.IsNullOrEmpty(Matricula))
        {
            GenerarQR();
        }
    }

    private void GenerarQR()
    {
        try
        {
            using (QRCodeGenerator qrGenerator = new QRCodeGenerator())
            {
                QRCodeData qrCodeData = qrGenerator.CreateQrCode(Matricula, QRCodeGenerator.ECCLevel.Q);
                PngByteQRCode qrCode = new PngByteQRCode(qrCodeData);
                byte[] qrCodeImage = qrCode.GetGraphic(20);
                ImagenQrBase64 = $"data:image/png;base64,{Convert.ToBase64String(qrCodeImage)}";
            }
        }
        catch (Exception)
        {
            ImagenQrBase64 = "";
        }
    }

    private async Task Imprimir()
    {
        // TRUCO: Esperar un poco para asegurar que el DOM se renderizó y la imagen cargó
        // antes de lanzar la orden de imprimir al navegador.
        await Task.Delay(500);
        await JSRuntime.InvokeVoidAsync("print");
    }

    private Task Cerrar()
    {
        return MostrarChanged.InvokeAsync(false);
    }
}