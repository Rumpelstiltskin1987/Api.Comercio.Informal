@page "/gremios"
@using Api.Comercio.Informal.Components.Layout
@using Microsoft.AspNetCore.Components.QuickGrid
@inject BusinessGremio _gremioService
@inject BusinessLider _liderService
@inject BusinessFolio _folioService
@rendermode InteractiveServer

<link href="css/general.css" rel="stylesheet" />

<h3 class="mb-4 text-uppercase" style="color: #333; letter-spacing: 1px;">Directorio de Gremios</h3>
<hr />

<div class="d-flex justify-content-between mb-4 align-items-center">
    <button class="btn official-btn-primary btn-lg" @onclick="AbrirModalCrear">
        <i class="bi bi-plus-circle me-2"></i> Registrar Nuevo
    </button>

    <button class="btn official-btn-outline-secondary" @onclick="AlternarVista">
        @if (mostrarActivos)
        {
            <span><i class="bi bi-archive me-2"></i> Consultar Archivo Muerto</span>
        }
        else
        {
            <span><i class="bi bi-check2-circle me-2"></i> Consultar Activos</span>
        }
    </button>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        @if (listado == null)
        {
            <div class="p-5 text-center">
                <div class="spinner-border text-secondary" role="status"></div>
                <p class="mt-3 text-muted text-uppercase small">No existen registros en la base de datos...</p>
            </div>
        }
        else
        {
            <QuickGrid Items="@listado" Pagination="@paginationState" Class="table mb-0 official-grid">
                <PropertyColumn Property="@(c => c.Descripcion)" Sortable="true" Title="Descripción" />
                <PropertyColumn Property="@(c => c.Lider != null ? $"{c.Lider.Nombre} {c.Lider.A_paterno} {c.Lider.A_materno}" : string.Empty)" Sortable="true" Title="Lider" />
                <TemplateColumn Title="Gestión" Align="Align.Right">
                    <div class="d-flex gap-2 justify-content-end">
                        <button class="btn btn-sm btn-link p-0 text-decoration-none" title="Editar Información" @onclick="() => AbrirModalEditar(context)">
                            <i class="bi bi-pencil-square fs-6"></i>
                        </button>
                        <button class="btn btn-sm btn-link p-0 m-0 text-decoration-none" title="Ver Detalles" @onclick="() => AbrirModalDetalle(context)">
                            <i class="bi bi-eye fs-6"></i>
                        </button>
                        @if (mostrarActivos)
                        {
                            <button class="btn btn-sm btn-link p-0 m-0 text-decoration-none text-danger" title="Dar de Baja" @onclick="() => Baja(context)">
                                <i class="bi bi-trash fs-6"></i>
                            </button>
                        }
                    </div>
                </TemplateColumn>
            </QuickGrid>

            <div class="paginator-container p-2 border-top bg-light">
                <PaginadorEsp State="@paginationState" />
            </div>
        }
    </div>
</div>

<SimpleModal Show="mostrarModal" Title="@tituloModal" OnCancel="CerrarModal" OnConfirm="Guardar">
    <div class="row g-3">
        <div class="col-12">
            <label class="form-label small text-muted text-uppercase fw-bold lblwidth">Nombre del Gremio</label>
            <input class="form-control" @bind="gremio.Descripcion" />
        </div>
        <div class="col-12">
            <label class="form-label small text-muted text-uppercase fw-bold lblwidth">Líder Asignado</label>
            <select class="form-select" @bind="gremio.Id_lider">
                <option value="0">-- Seleccione un líder --</option>
                @if (lideres != null)
                {
                    @foreach (var lider in lideres)
                    {
                        <option value="@lider.Id_lider">@($"{lider.Nombre} {lider.A_paterno} {lider.A_materno}")</option>
                    }
                }
            </select>
        </div>
    </div>
</SimpleModal>

@code {
    // --- Datos ---
    private IQueryable<Gremio>? listado;
    private IEnumerable<Lider>? lideres = new List<Lider>();
    private bool mostrarActivos = true;
    private PaginationState paginationState = new PaginationState { ItemsPerPage = 10 };    

    // --- Modal ---
    private bool mostrarModal = false;
    private string tituloModal = "";

    // Inicialización segura
    private Gremio gremio = new Gremio
    {
        Descripcion = "",
        Id_lider = 0
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await CargarDatos();
            await CargarLideres();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar datos del padrón: {ex.Message}");
            listado = null;
        }
    }

    private async Task CargarDatos()
    {
        var lista = await _gremioService.GetAll();
        var filtrados = mostrarActivos
            ? lista.Where(c => c.Estado == "A")
            : lista.Where(c => c.Estado == "I");

        listado = filtrados.AsQueryable();
    }

    private async Task CargarLideres()
    {
        var todosLideres = await _liderService.GetAll();
        lideres = todosLideres.Where(l => l.Estado == "A").ToList();
    }

    private async Task AlternarVista()
    {
        mostrarActivos = !mostrarActivos;
        listado = null; // Reset visual para efecto de carga
        try
        {
            await CargarDatos();
        }
        catch (Exception ex)
        {
            listado = null;
        }
    }

    // --- Lógica Modal ---
    private void AbrirModalCrear()
    {
        gremio = new Gremio
        {
            Descripcion = "",
            Id_gremio = 0,
            Id_lider = 0
        };
        tituloModal = "REGISTRO DE NUEVO CONCEPTO DE COBRO";
        mostrarModal = true;
    }

    private void AbrirModalEditar(Gremio item)
    {
        // Clonación manual para edición segura
        gremio = new Gremio
        {
            Id_gremio = item.Id_gremio,
            Descripcion = item.Descripcion,
            Id_lider = item.Id_lider
        };
        tituloModal = "ACTUALIZACIÓN DE DATOS";
        mostrarModal = true;
    }

    private void AbrirModalDetalle(Gremio item)
    {
        // Clonación manual para edición segura
        gremio = new Gremio
        {
            Id_gremio = item.Id_gremio,
            Descripcion = item.Descripcion,
            Id_lider = item.Id_lider
        };
        tituloModal = "DETALLES DEL GREMIO";
        mostrarModal = true;
    }

    private void CerrarModal() => mostrarModal = false;

    private async Task Guardar()
    {
        if (string.IsNullOrWhiteSpace(gremio.Descripcion) || gremio.Id_lider == 0)
        {
            return;
        }

        if (gremio.Id_gremio == 0)
        {
            await _gremioService.Create(
                gremio.Descripcion, gremio.Id_lider, "Administrador"
            );  

            var resultados = await _gremioService.Search(gremio.Descripcion, gremio.Id_lider, "A");
            var nuevoGremio = resultados.FirstOrDefault();

            var descripcionFolio = $"Folio correspondiente al gremio {gremio.Descripcion}";
            var prefijo = gremio.Descripcion.Length >= 3
                ? gremio.Descripcion.Substring(0, 3).ToUpper()
                : gremio.Descripcion.ToUpper();

            await _folioService.Create(nuevoGremio.Id_gremio, descripcionFolio, prefijo);
        }
        else
        {
            await _gremioService.Update(
                gremio.Id_gremio, gremio.Descripcion, gremio.Id_lider, gremio.Estado, "Administrador"
            );
        }

        mostrarModal = false;
        await CargarDatos();
    }

    private async Task Baja(Gremio gremio)
    {
        await _gremioService.Update(
            gremio.Id_gremio, gremio.Descripcion, gremio.Id_lider, "I", "Administrador"
        );
        await CargarDatos();
    }
}