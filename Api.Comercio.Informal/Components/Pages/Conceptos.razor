@page "/conceptos"
@using Api.Comercio.Informal.Components.Layout
@using Microsoft.AspNetCore.Components.QuickGrid
@using Api.Entities
@using Api.Business
@inject IJSRuntime JSRuntime
@inject BusinessConcepto _conceptoService
@inject AuthenticationStateProvider GetAuthenticationStateProvider
@attribute [Authorize(Roles = "Supervisor")]
@rendermode InteractiveServer

<link href="css/general.css" rel="stylesheet" />

<h3 class="mb-4 text-uppercase" style="color: #333; letter-spacing: 1px;">Conceptos de Pago</h3>
<hr />

<div class="d-flex justify-content-between mb-4 align-items-center">
    <button class="btn official-btn-primary btn-lg" @onclick="AbrirModalCrear">
        <i class="bi bi-plus-circle me-2"></i> Registrar Nuevo
    </button>

    <button class="btn official-btn-outline-secondary" @onclick="AlternarVista">
        @if (mostrarActivos)
        {
            <span><i class="bi bi-archive me-2"></i> Consultar Archivo Muerto</span>
        }
        else
        {
            <span><i class="bi bi-check2-circle me-2"></i> Consultar Activos</span>
        }
    </button>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <QuickGrid Items="@listado" Pagination="@paginationState" Class="table mb-0 official-grid grid-conceptos">
            <PropertyColumn Property="@(c => c.Descripcion)" Sortable="true" Title="Descipción" />

            <TemplateColumn Title="Gestión">
                <div class="d-flex gap-2">
                    @if (mostrarActivos)
                    {
                        <button class="btn btn-sm btn-link p-0 text-decoration-none" title="Editar Información" @onclick="() => AbrirModalEditar(context)">
                            <i class="bi bi-pencil-square fs-6"></i>
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-link p-0 text-decoration-none text-success" title="Reincorporar" @onclick='() => CambiarEstado(context, "A")'>
                            <i class="bi bi-box-arrow-up fs-6"></i>
                        </button>
                    }

                    @* <button class="btn btn-sm btn-link p-0 m-0 text-decoration-none" title="Ver Detalles" @onclick="() => AbrirModalDetalle(context)">
                        <i class="bi bi-eye fs-6"></i>
                    </button> *@

                    @if (mostrarActivos)
                    {
                        <button class="btn btn-sm btn-link p-0 m-0 text-decoration-none text-danger" title="Dar de Baja" @onclick='() => CambiarEstado(context, "I")'>
                            <i class="bi bi-trash fs-6"></i>
                        </button>
                    }
                </div>
            </TemplateColumn>
        </QuickGrid>

        <div class="paginator-container p-2 border-top bg-light">
            <PaginadorEsp State="@paginationState" />
        </div>
    </div>
</div>

<SimpleModal Show="mostrarModal" Title="@tituloModal" OnCancel="CerrarModal" OnConfirm="GuardarConcepto" HideSaveButton="@soloLectura">
    <fieldset disabled="@soloLectura" class="border-0 p-0 m-0" style="border: none;">
        <div class="row g-3">
            <div class="col-12">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth">Descripción</label>
                <input class="form-control" @bind="concepto.Descripcion" />
            </div>
        </div>
    </fieldset>
</SimpleModal>

@code {
    // --- Datos ---
    private IQueryable<Concepto>? listado;
    private PaginationState paginationState = new PaginationState { ItemsPerPage = 10 };
    private bool mostrarActivos = true;
    private bool soloLectura = false; // Bandera para controlar el modo del modal
    private string usuario = "";

    // --- Modal ---
    private bool mostrarModal = false;
    private string tituloModal = "";

    // Inicialización segura
    private Concepto concepto = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Obtener el usuario logueado
            var authState = await GetAuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            usuario = user.Identity?.Name ?? "System";

            await CargarDatos();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", $"Ocurrió un error al cargar la información: {ex.Message}", "error");
            return;
        }
    }

    private async Task CargarDatos()
    {
        var lista = await _conceptoService.GetAll();
        var filtrados = mostrarActivos
            ? lista.Where(c => c.Estado == "A")
            : lista.Where(c => c.Estado == "I");

        listado = filtrados.AsQueryable();
    }

    private async Task AlternarVista()
    {
        mostrarActivos = !mostrarActivos;
        try
        {
            await CargarDatos();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", $"Ocurrió un error al cargar la información: {ex.Message}", "error");
            return;
        }
    }

    // --- Lógica Modal ---
    private void AbrirModalCrear()
    {
        soloLectura = false;
        concepto = new();
        tituloModal = "REGISTRO DE NUEVO CONCEPTO";
        mostrarModal = true;
    }

    private void AbrirModalEditar(Concepto item)
    {
        soloLectura = false;
        // Clonación manual para edición segura
        concepto = new()
        {
            Id_concepto = item.Id_concepto,
            Descripcion = item.Descripcion,
            Estado = item.Estado,
            Usuario_alta = item.Usuario_alta
        };
        tituloModal = "ACTUALIZACIÓN DE DATOS";
        mostrarModal = true;
    }

    private void AbrirModalDetalle(Concepto item)
    {
        soloLectura = true;
        // Clonación manual para edición segura
        concepto = new()
        {
            Id_concepto = item.Id_concepto,
            Descripcion = item.Descripcion,
            Estado = item.Estado,
            Usuario_alta = item.Usuario_alta
        };
        tituloModal = "DETALLES DEL CONCEPTO";
        mostrarModal = true;
    }

    private void CerrarModal() => mostrarModal = false;

    private async Task GuardarConcepto()
    {
        if (string.IsNullOrWhiteSpace(concepto.Descripcion))
        {
            return;
        }

        if (concepto.Id_concepto == 0)
        {
            await _conceptoService.Create(
                concepto.Descripcion, usuario
            );
        }
        else
        {
            await _conceptoService.Update(
                concepto.Id_concepto, concepto.Descripcion, concepto.Estado,
                usuario
            );
        }

        mostrarModal = false;        

        await JSRuntime.InvokeVoidAsync("Swal.fire", new
        {
            title = "¡Éxito!",
            text = "La información se guardó correctamente.",
            icon = "success",
            confirmButtonColor = "#9D2449"
        });

        await CargarDatos();
    }

    // Método unificado para cambiar estado (Baja / Reincorporar)
    private async Task CambiarEstado(Concepto item, string estado)
    {
        try
        {
            await _conceptoService.Update(
            item.Id_concepto, item.Descripcion, estado, usuario
        );

            await CargarDatos();

            var accion = estado == "A" ? "reactivó" : "dio de baja";
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Éxito", $"El registro se {accion} correctamente.", "success");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", $"Error al actualizar estado: {ex.Message}", "error");
        }
    }
}


