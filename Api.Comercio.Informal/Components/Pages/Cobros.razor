@page "/recaudacion"
@using Api.Comercio.Informal.Components.Layout
@using Api.Entities
@using Api.Business
@using Microsoft.AspNetCore.Components.QuickGrid
@inject IJSRuntime JSRuntime
@inject BusinessRecaudacion _recaudacionService
@rendermode InteractiveServer

<link href="css/recaudacion.css" rel="stylesheet" />

@* <h3 class="mb-4 text-uppercase" style="color: #333; letter-spacing: 1px;">Consultas de Recaudación de Impuestos</h3> *@
@* <hr /> *@

<div class="d-flex justify-content-between mb-4 align-items-center flex-wrap gap-3" style="padding: 2px">
    <div class="d-flex align-items-center gap-3">
        <label class="h5 mb-0 text-nowrap">Recaudación del día:</label>
        @* Filtro de Fecha para controlar qué recaudación se ve *@
        <input type="date" class="form-control" @bind="fechaFiltro" @bind:after="AplicarFiltro" style="max-width: 180px;" />
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <QuickGrid Items="@listado" Class="table mb-0 official-grid grid-recaudacion">
            <PropertyColumn Property="@(c => c.Padron.Nombre)" Sortable="true" Title="Contrubuyente" />
            <PropertyColumn Property="@(c => c.Padron.Gremio.Descripcion)" Sortable="true" Title="Gremio" />
            <PropertyColumn Property="@(c => c.Concepto.Descripcion)" Sortable="true" Title="Concepto" />
            <PropertyColumn Property="@(c => c.Monto)" Sortable="true" Title="Monto" Format="C" />
            <PropertyColumn Property="@(c => c.Folio_Recibo)" Sortable="true" Title="Folio" />
        </QuickGrid>
    </div>
</div>

@code {
    // --- Variables de Estado ---
    private IQueryable<Recaudacion>? listado;
    // Variable para almacenar TODOS los datos traídos del servicio (cache simple)
    private IEnumerable<Recaudacion>? todosLosRegistros;

    private PaginationState paginationState = new PaginationState { ItemsPerPage = 10 };
    private DateTime fechaFiltro = DateTime.Today; // Por defecto hoy

    // Definición de ordenamientos personalizados para TemplateColumns
    GridSort<Recaudacion> sortFecha = GridSort<Recaudacion>.ByDescending(x => x.Fecha_cobro);
    GridSort<Recaudacion> sortMonto = GridSort<Recaudacion>.ByDescending(x => x.Monto);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await CargarDatos();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", $"Ocurrió un error al cargar la información: {ex.Message}", "error");
        }
    }

    private async Task CargarDatos()
    {
        // 1. Obtenemos todo desde la capa de negocio
        todosLosRegistros = await _recaudacionService.GetAll();

        // 2. Aplicamos el filtro inicial
        AplicarFiltro();
    }

    private void AplicarFiltro()
    {
        if (todosLosRegistros != null)
        {
            // Filtramos en memoria por la fecha seleccionada (comparando solo la parte de Fecha, ignorando hora)
            var filtrados = todosLosRegistros
                .Where(x => x.Fecha_cobro.Date == fechaFiltro.Date);

            // Convertimos a IQueryable para el QuickGrid
            listado = filtrados.AsQueryable();
        }
    }
}