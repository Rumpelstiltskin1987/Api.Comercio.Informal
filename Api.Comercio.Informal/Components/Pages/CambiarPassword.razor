@page "/cambiar-password"
@layout LoginLayout
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using Api.Entities
@using Api.Comercio.Informal.Components.Layout
@inject UserManager<Usuario> UserManager
@inject SignInManager<Usuario> SignInManager
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<div class="login-bg">
    <div class="login-box">
        <h3 class="text-center mb-3 text-uppercase" style="color: #333; letter-spacing: 1px;">Cambio de Contraseña</h3>
        <p class="text-center small mb-4" style="color: black !important;">
            Por seguridad, tu contraseña es temporal. Debes crear una nueva para continuar.
        </p>

        <EditForm Model="Input" OnValidSubmit="ActualizarPassword" FormName="changePassForm" method="post">
            <DataAnnotationsValidator />

            @* 1. Contraseña Temporal (Actual) *@
            <div class="mb-3">
                <label class="form-label small lbl-fixed mb-0">Contraseña Temporal</label>
                <center>
                    <div class="marg-buttom">
                        <InputText @bind-Value="Input.OldPassword" type="password" class="form-control" placeholder="La que te dio el IT Manager" />
                        <ValidationMessage For="() => Input.OldPassword" class="text-danger small" style="color: red !important;" />
                    </div>
                </center>                
            </div>

            @* 2. Nueva Contraseña *@
            <div class="mb-3">
                <label class="form-label small lbl-fixed mb-0">Nueva Contraseña</label>
                <center>
                    <div class="marg-buttom">
                        <InputText @bind-Value="Input.NewPassword" type="password" class="form-control" placeholder="Mínimo 6 caracteres" />
                        <ValidationMessage For="() => Input.NewPassword" class="text-danger small" style="color: red !important;" />
                    </div>
                </center>                
            </div>

            @* 3. Confirmar *@
            <div class="mb-4">
                <label class="form-label small lbl-fixed mb-0">Confirmar Nueva</label>
                <center>
                    <div class="marg-buttom">
                        <InputText @bind-Value="Input.ConfirmPassword" type="password" class="form-control" placeholder="Repite la nueva contraseña" />
                        <ValidationMessage For="() => Input.ConfirmPassword" class="text-danger small" style="color: red !important;" />
                    </div>
                </center>                
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger py-2 small text-center">@errorMessage</div>
            }

            <center>
                <button type="submit" class="btn btn-siscoin w-100 shadow">
                    ACTUALIZAR Y ENTRAR
                </button>
            </center>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromForm] private ChangePasswordModel Input { get; set; } = new();
    private string? errorMessage;

    private async Task ActualizarPassword()
    {
        // 1. Obtener usuario actual
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userPrincipal = authState.User;

        if (userPrincipal.Identity is null || !userPrincipal.Identity.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        var user = await UserManager.GetUserAsync(userPrincipal);
        if (user == null)
        {
            errorMessage = "Error de sesión. Vuelve a iniciar.";
            return;
        }

        // 2. Intentar cambiar la contraseña (Identity valida que la actual sea correcta)
        var result = await UserManager.ChangePasswordAsync(user, Input.OldPassword, Input.NewPassword);

        if (!result.Succeeded)
        {
            // Usamos el ErrorDescriber que configuramos antes para mostrar mensajes en español
            errorMessage = string.Join(" ", result.Errors.Select(e => e.Description));
            return;
        }

        // 3. Éxito: Apagar la bandera temporal
        user.EsPasswordTemporal = false;
        await UserManager.UpdateAsync(user);

        // 4. Refrescar cookie y redirigir
        await SignInManager.RefreshSignInAsync(user);
        Navigation.NavigateTo("/", forceLoad: true);
    }

    public class ChangePasswordModel
    {
        [Required(ErrorMessage = "Debes ingresar la contraseña temporal")]
        public string OldPassword { get; set; } = "";

        [Required(ErrorMessage = "La nueva contraseña es requerida")]
        [MinLength(6, ErrorMessage = "Mínimo 6 caracteres")]
        public string NewPassword { get; set; } = "";

        [Compare(nameof(NewPassword), ErrorMessage = "Las contraseñas no coinciden")]
        public string ConfirmPassword { get; set; } = "";
    }
}