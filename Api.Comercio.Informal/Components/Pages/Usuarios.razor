@page "/admin/usuarios"
@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Api.Entities
@using Api.Entities.DTO
@using Api.Comercio.Informal.Components.Layout
@inject IJSRuntime JSRuntime
@inject UserManager<Api.Entities.Usuario> _userManager
@inject RoleManager<IdentityRole<int>> _roleManager
@inject AuthenticationStateProvider GetAuthenticationStateProvider
@attribute [Authorize(Roles = "Superadmin ,IT Manager")]
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<link href="css/general.css" rel="stylesheet" />

<h3 class="mb-4 text-uppercase" style="color: #333; letter-spacing: 1px;">Control de Usuarios y Perfiles</h3>
<hr />

<div class="d-flex justify-content-between mb-4 align-items-center">
    <button class="btn official-btn-primary btn-lg" @onclick="AbrirModalCrear">
        <i class="bi bi-plus-circle me-2"></i> Registrar Nuevo
    </button>

    @* <button class="btn official-btn-outline-secondary" @onclick="AlternarVista">
        @if (mostrarActivos)
        {
            <span><i class="bi bi-archive me-2"></i> Consultar Archivo Muerto</span>
        }
        else
        {
            <span><i class="bi bi-check2-circle me-2"></i> Consultar Activos</span>
        }
    </button> *@
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <QuickGrid Items="@usuariosExtQueryable" TGridItem="DtoUsuario" Pagination="@paginationState" Class="table mb-0 official-grid grid-usuarios">
            <PropertyColumn Property="@(c => c.UserName)" Sortable="true" Title="Usuario" />
            <PropertyColumn Property="@(c => c.Nombre)" Sortable="true" Title="Nombre(s)" />
            <PropertyColumn Property="@(c => c.A_paterno)" Sortable="true" Title="Apellido Paterno" />
            <PropertyColumn Property="@(c => c.A_materno)" Sortable="true" Title="Apellido Materno" />
            <PropertyColumn Property="@(c => c.Rol)" Sortable="true" Title="Rol" />

            <TemplateColumn Title="Gestión">
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-link p-0 text-decoration-none" title="Editar Información" @onclick="() => AbrirModalEditar(context)">
                        <i class="bi bi-pencil-square fs-6"></i>
                    </button>
                    <button class="btn btn-sm btn-link p-0 m-0 text-decoration-none" title="Ver Detalles" @onclick="() => AbrirModalDetalle(context)">
                        <i class="bi bi-eye fs-6"></i>
                    </button>
                </div>
            </TemplateColumn>
        </QuickGrid>

        <div class="paginator-container p-2 border-top bg-light">
            <PaginadorEsp State="@paginationState" />
        </div>
    </div>
</div>

<SimpleModal Show="mostrarModal" Title="@tituloModal" OnCancel="CerrarModal" OnConfirm="GuardarUsuario" HideSaveButton="@soloLectura">
    <fieldset disabled="@soloLectura" class="border-0 p-0 m-0" style="border: none;">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Usuario</label>
                <input class="form-control" @bind="inputModel.UserName" />
            </div>

            <div class="col-md-6">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Nombre(s)</label>
                <input class="form-control" @bind="inputModel.Nombre" />
            </div>
            <div class="col-md-6">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Apellido Paterno</label>
                <input class="form-control" @bind="inputModel.A_paterno" />
            </div>
            <div class="col-md-6">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Apellido Materno</label>
                <input class="form-control" @bind="inputModel.A_materno" />
            </div>
            <div class="col-md-6">
                <label class="form-label small text-muted text-uppercase fw-bold">Teléfono</label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-telephone"></i></span>
                    <input class="form-control" @bind="inputModel.PhoneNumber" placeholder="10 dígitos" />
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label small text-muted text-uppercase fw-bold">Correo Electrónico</label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-envelope"></i></span>
                    <input class="form-control" @bind="inputModel.Email" placeholder="oficial@dominio.gob" />
                </div>
            </div>

            @* Solo mostramos contraseña si es un registro NUEVO (Id == 0) *@
            @if (inputModel.Id == 0)
            {
                <div class="col-md-6">
                    <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Contraseña</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="bi bi-key"></i></span>
                        <input type="password" class="form-control" @bind="inputModel.Password" placeholder="Mínimo 6 caracteres" />
                    </div>
                </div>
            }
            <div class="col-12">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Rol Asignado</label>
                <select class="form-select" @bind="inputModel.Rol">
                    <option value="0">-- Seleccione un Rol --</option>
                    @if (rolesDisponibles != null)
                    {
                        @foreach (var rol in rolesDisponibles)
                        {
                            @if (rol != "Superadmin")
                            {
                                <option value="@rol">@rol</option>
                            }
                        }
                    }
                </select>
            </div>
        </div>
    </fieldset>
</SimpleModal>

@code {
    private List<Usuario> usuarios = new();
    private List<DtoUsuario> usuariosExt = new();
    private IQueryable<DtoUsuario> usuariosExtQueryable = Enumerable.Empty<DtoUsuario>().AsQueryable();
    private List<string> rolesDisponibles = new();
    private PaginationState paginationState = new PaginationState { ItemsPerPage = 10 };
    private bool soloLectura = false;
    private bool mostrarActivos = true;
    private bool mostrarModal = false;
    private string tituloModal = "";
    private string usuario = "";
    private string rolAnterior = "";

    private DtoUsuario inputModel = new();

    protected override async Task OnInitializedAsync()
    {
        // Obtener el usuario logueado
        var authState = await GetAuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        usuario = user.Identity?.Name ?? "System";

        // Obtener roles disponibles
        rolesDisponibles = await _roleManager.Roles.Select(r => r.Name).ToListAsync();

        // Cargar usuarios
        await CargarUsuarios();
    }

    private async Task AlternarVista()
    {
        mostrarActivos = !mostrarActivos;
        try
        {
            await CargarUsuarios();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", $"Ocurrió un error al cargar la información: {ex.Message}", "error");
            return;
        }
    }

    private async Task CargarUsuarios()
    {
        usuarios.Clear();
        usuariosExt.Clear();
        usuarios = await _userManager.Users.ToListAsync();

        foreach (var u in usuarios)
        {
            var roles = await _userManager.GetRolesAsync(u);

            // Si el usuario tiene el rol "Superadmin", saltamos al siguiente (no lo agregamos)
            if (roles.Contains("Superadmin"))
            {
                continue;
            }

            DtoUsuario usuarioExt = new DtoUsuario
            {
                UserName = u.UserName,
                Id = u.Id,
                Nombre = u.Nombre,
                A_paterno = u.A_paterno,
                A_materno = u.A_materno,
                PhoneNumber = u.PhoneNumber,
                Email = u.Email,
                Rol = roles.FirstOrDefault() ?? "Sin Rol"
            };

            usuariosExt.Add(usuarioExt);
        }
        usuariosExtQueryable = usuariosExt.AsQueryable();
    }

    private void AbrirModalCrear()
    {
        soloLectura = false;
        inputModel = new();
        tituloModal = "REGISTRO DE NUEVO USUARIO";
        mostrarModal = true;
    }

    private void AbrirModalEditar(DtoUsuario item)
    {
        soloLectura = false;
        rolAnterior = item.Rol;

        // Clonación manual necesaria para editar
        inputModel = new DtoUsuario
        {
            Id = item.Id,
            Nombre = item.Nombre,
            A_paterno = item.A_paterno,
            A_materno = item.A_materno,
            PhoneNumber = item.PhoneNumber,
            Email = item.Email,
            UserName = item.UserName,
            Rol = item.Rol
        };
        tituloModal = "ACTUALIZACIÓN DE DATOS";
        mostrarModal = true;
    }

    private void AbrirModalDetalle(DtoUsuario item)
    {
        soloLectura = true;
        inputModel = item;
        tituloModal = "DETALLES DEL ASUARIO";
        mostrarModal = true;
    }

    private void CerrarModal() => mostrarModal = false;

    private async Task GuardarUsuario()
    {
        // Validaciones básicas
        if (string.IsNullOrWhiteSpace(inputModel.UserName) ||
            string.IsNullOrWhiteSpace(inputModel.Nombre) ||
            string.IsNullOrWhiteSpace(inputModel.A_paterno) ||
            string.IsNullOrWhiteSpace(inputModel.A_materno) ||
            string.IsNullOrWhiteSpace(inputModel.Password) ||
            string.IsNullOrWhiteSpace(inputModel.Rol))
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Atención", "Faltan datos obligatorios", "warning");
            return;
        }
        try
        {
            if (inputModel.Id == 0)
            {
                Usuario nuevoUsuario = new()
                {
                    Nombre = inputModel.Nombre,
                    A_paterno = inputModel.A_paterno,
                    A_materno = inputModel.A_materno,
                    PhoneNumber = inputModel.PhoneNumber,
                    Email = inputModel.Email,
                    UserName = inputModel.UserName,
                    EmailConfirmed = true,
                    EsPasswordTemporal = true,
                    Usuario_alta = usuario
                };

                var result = await _userManager.CreateAsync(nuevoUsuario, inputModel.Password);
                if (!result.Succeeded)
                {
                    var errores = string.Join("<br/>", result.Errors.Select(e => e.Description));
                    await JSRuntime.InvokeVoidAsync("Swal.fire", "Error al crear usuario", errores, "error");
                    return;
                }
                // Asignar rol seleccionado
                await _userManager.AddToRoleAsync(nuevoUsuario, inputModel.Rol);
            }
            else
            {
                // Buscar el usuario que se va a editar en la DB
                var usuarioDb = await _userManager.FindByIdAsync(inputModel.Id.ToString());

                if (usuarioDb != null)
                {
                    // Mapear datos del formulario al objeto de la DB
                    usuarioDb.Nombre = inputModel.Nombre;
                    usuarioDb.A_paterno = inputModel.A_paterno;
                    usuarioDb.A_materno = inputModel.A_materno;
                    usuarioDb.PhoneNumber = inputModel.PhoneNumber;
                    usuarioDb.Email = inputModel.Email;
                    usuarioDb.UserName = inputModel.UserName;

                    // ASIGNAR CAMPOS DE AUDITORÍA
                    usuarioDb.Usuario_modificacion = usuario;
                    usuarioDb.Fecha_modificacion = DateTime.Now;

                    // Actualizar
                    var result = await _userManager.UpdateAsync(usuarioDb);

                    if (result.Succeeded)
                    {
                        await JSRuntime.InvokeVoidAsync("Swal.fire", "Éxito", "Usuario actualizado", "success");
                    }
                }

                if (inputModel.Rol != rolAnterior)
                {
                    await CambiarRol(usuarioDb, inputModel.Rol);
                }


            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", $"Ocurrió un error: {ex.Message}", "error");
            return;
        }

        mostrarModal = false;

        await JSRuntime.InvokeVoidAsync("Swal.fire", new
        {
            title = "¡Éxito!",
            text = $"Se registró el usuario {inputModel.UserName} con el rol de {inputModel.Rol}.",
            icon = "success",
            confirmButtonColor = "#9D2449"
        });

        await CargarUsuarios();
    }

    private async Task CambiarRol(Usuario userView, string nuevoRol)
    {
        try
        {
            var user = await _userManager.FindByIdAsync(userView.Id.ToString());
            if (user == null) return;

            // Quitar roles actuales
            var rolesActuales = await _userManager.GetRolesAsync(user);
            await _userManager.RemoveFromRolesAsync(user, rolesActuales);

            // Agregar nuevo rol
            var result = await _userManager.AddToRoleAsync(user, nuevoRol);

            if (result.Succeeded)
            {
                await JSRuntime.InvokeVoidAsync("Swal.fire", "Actualizado",
                    $"El usuario {user.Email} ahora tiene el perfil de {nuevoRol}.", "success");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", ex.Message, "error");
        }
        finally
        {
            await CargarUsuarios();
        }
    }
}


<style>
    .text-guinda {
        color: #9D2449;
    }

    .bg-guinda {
        background-color: #9D2449;
    }
</style>