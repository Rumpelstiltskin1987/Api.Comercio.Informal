@page "/padron"
@using Api.Entities
@using Api.Business
@using Api.Comercio.Informal.Components.Layout
@inject BusinessPadron _padronService
@rendermode InteractiveServer

<link href="css/cobradores.css" rel="stylesheet" />

<h3 class="mb-4 text-uppercase" style="color: #333; letter-spacing: 1px;">Padron de Vendedores</h3>
<hr />

<div class="d-flex justify-content-between mb-4 align-items-center">
    <button class="btn official-btn-primary btn-lg" @onclick="AbrirModalCrear">
        <i class="bi bi-plus-circle me-2"></i> Registrar Nuevo
    </button>

    <button class="btn official-btn-outline-secondary" @onclick="AlternarVista">
        @if (mostrarActivos)
        {
            <span><i class="bi bi-archive me-2"></i> Consultar Archivo Muerto</span>
        }
        else
        {
            <span><i class="bi bi-check2-circle me-2"></i> Consultar Activos</span>
        }
    </button>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        @if (listado == null)
        {
            <div class="p-5 text-center">
                <div class="spinner-border text-secondary" role="status"></div>
                <p class="mt-3 text-muted text-uppercase small">No existen registros en la base de datos...</p>
            </div>
        }
        else
        {
            <QuickGrid Items="@listado" Pagination="@paginationState" Class="table mb-0 official-grid">
                <PropertyColumn Property="@(c => c.Nombre)" Sortable="true" Title="Nombre(s)" />
                <PropertyColumn Property="@(c => c.A_paterno)" Sortable="true" Title="Primer Apellido" />
                <PropertyColumn Property="@(c => c.A_materno)" Sortable="true" Title="Segundo Apellido" />
                <PropertyColumn Property="@(c => c.Telefono)" Sortable="true" Title="Teléfono" />
                <PropertyColumn Property="@(c => c.Email)" Sortable="true" Title="Correo Electrónico" />

                <TemplateColumn Title="Estatus" Sortable="true" SortBy="@sortPorEstado">
                    <span class="status-badge @(context.Estado == "A" ? "status-active" : "status-inactive")">
                        @(context.Estado == "A" ? "VIGENTE" : "BAJA")
                    </span>
                </TemplateColumn>

                <TemplateColumn Title="Gestión">
                    <div class="d-flex gap-2 justify-content-end">
                        <button class="btn btn-sm btn-link p-0 text-decoration-none" title="Editar Información" @onclick="() => AbrirModalEditar(context)">
                            <i class="bi bi-pencil-square fs-6"></i>
                        </button>
                        @if (mostrarActivos)
                        {
                            <button class="btn btn-sm btn-link p-0 text-decoration-none text-danger" title="Dar de Baja" @onclick="() => Baja(context)">
                                <i class="bi bi-trash fs-6"></i>
                            </button>
                        }
                    </div>
                </TemplateColumn>
            </QuickGrid>

            <div class="paginator-container d-flex justify-content-end">
                <Paginator State="@paginationState" />
            </div>
        }
    </div>
</div>

<SimpleModal Show="mostrarModal" Title="@tituloModal" OnCancel="CerrarModal" OnConfirm="GuardarPadron">
    <div class="row g-3">
        <div class="col-12">
            <label class="form-label small text-muted text-uppercase fw-bold">Nombre(s)</label>
            <input class="form-control" @bind="registro.Nombre" placeholder="Ingrese nombre completo" />
        </div>
        <div class="col-md-6">
            <label class="form-label small text-muted text-uppercase fw-bold">Apellido Paterno</label>
            <input class="form-control" @bind="registro.A_paterno" />
        </div>
        <div class="col-md-6">
            <label class="form-label small text-muted text-uppercase fw-bold">Apellido Materno</label>
            <input class="form-control" @bind="registro.A_materno" />
        </div>
        <div class="col-md-6">
            <label class="form-label small text-muted text-uppercase fw-bold">Teléfono</label>
            <div class="input-group">
                <span class="input-group-text bg-light"><i class="bi bi-telephone"></i></span>
                <input class="form-control" @bind="registro.Telefono" placeholder="10 dígitos" />
            </div>
        </div>
        <div class="col-md-6">
            <label class="form-label small text-muted text-uppercase fw-bold">Correo Electrónico</label>
            <div class="input-group">
                <span class="input-group-text bg-light"><i class="bi bi-envelope"></i></span>
                <input class="form-control" @bind="registro.Email" placeholder="oficial@dominio.gob" />
            </div>
        </div>
    </div>
</SimpleModal>

@code {
    // --- Datos ---
    private IQueryable<Padron>? listado;
    private PaginationState paginationState = new PaginationState { ItemsPerPage = 10 };
    private bool mostrarActivos = true;

    // GridSort para la columna personalizada de estado
    GridSort<Cobrador> sortPorEstado = GridSort<Cobrador>.ByAscending(c => c.Estado);

    // --- Modal ---
    private bool mostrarModal = false;
    private string tituloModal = "";

    // Inicialización segura
    private Padron registro = new Padron
    {
        Nombre = "",
        A_paterno = "",
        A_materno = "",
        Curp = "",
        Direccion = "",
        Telefono = "",
        Email = "",
        Matricula = "",
        Matricula_anterior = ""
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await CargarDatos();            
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar datos del padrón: {ex.Message}");
            listado = null;
        }
    }

    private async Task CargarDatos()
    {
        var lista = await _padronService.GetAll();

        var filtrados = mostrarActivos
            ? lista.Where(c => c.Estado == "A")
            : lista.Where(c => c.Estado == "I");

        listado = filtrados.AsQueryable();
    }

    private async Task AlternarVista()
    {
        mostrarActivos = !mostrarActivos;
        listado = null; // Reset visual para efecto de carga
        await CargarDatos();
    }

    // --- Lógica Modal ---
    private void AbrirModalCrear()
    {
        registro = new Padron
        {
            Nombre = "",
            A_paterno = "",
            A_materno = "",
            Curp = "",
            Direccion = "",
            Telefono = "",
            Email = "",
            Matricula = "",
            Matricula_anterior = ""
        };
        tituloModal = "REGISTRO DE NUEVO COBRADOR";
        mostrarModal = true;
    }

    private void AbrirModalEditar(Padron item)
    {
        // Clonación manual para edición segura
        registro = new Padron
        {
            Nombre = item.Nombre,
            A_paterno = item.A_paterno,
            A_materno = item.A_materno,
            Curp = item.Curp,
            Direccion = item.Direccion,
            Telefono = item.Telefono,
            Email = item.Email,
            Matricula = item.Matricula,
            Matricula_anterior = item.Matricula_anterior,
            Id_gremio = item.Id_gremio,
            Tipo_vendedor = item.Tipo_vendedor,
            Estado = item.Estado
        };
        tituloModal = "ACTUALIZACIÓN DE DATOS";
        mostrarModal = true;
    }

    private void CerrarModal() => mostrarModal = false;

    private async Task GuardarPadron()
    {
        if (string.IsNullOrWhiteSpace(registro.Nombre) || string.IsNullOrWhiteSpace(registro.A_paterno))
        {
            return;
        }

        if (registro.Id_padron == 0)
        {
            await _padronService.Create(
                registro.Nombre, registro.A_paterno, registro.A_materno,
                registro.Curp, registro.Direccion, registro.Telefono,
                registro.Email, registro.Matricula, registro.Id_gremio, "Administrador"
            );
        }
        else
        {
            await _padronService.Update(
                registro.Id_padron, registro.Nombre, registro.A_paterno, 
                registro.A_materno,registro.Curp, registro.Direccion, registro.Telefono,
                registro.Email, registro.Matricula,  registro.Matricula_anterior, registro.Id_gremio, 
                registro.Estado, "Administrador"
            );
        }

        mostrarModal = false;
        await CargarDatos();
    }

    private async Task Baja(Padron item)
    {
        await _padronService.Update(
            registro.Id_padron, registro.Nombre, registro.A_paterno,
                registro.A_materno, registro.Curp, registro.Direccion, registro.Telefono,
                registro.Email, registro.Matricula, registro.Matricula_anterior, registro.Id_gremio,
                "I", "Administrador"
        );
        await CargarDatos();
    }
}