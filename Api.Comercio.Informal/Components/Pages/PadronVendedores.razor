@page "/padron"
@using Api.Comercio.Informal.Components.Layout
@using Microsoft.AspNetCore.Components.QuickGrid
@using Api.Entities
@using Api.Business
@inject BusinessPadron _padronService
@inject BusinessGremio _gremioService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<link href="css/cobradores.css" rel="stylesheet" />

<h3 class="mb-4 text-uppercase" style="color: #333; letter-spacing: 1px;">Padron de Vendedores</h3>
<hr />

<div class="d-flex justify-content-between mb-4 align-items-center">
    <button class="btn official-btn-primary btn-lg" @onclick="AbrirModalCrear">
        <i class="bi bi-plus-circle me-2"></i> Registrar Nuevo
    </button>

    <button class="btn official-btn-outline-secondary" @onclick="AlternarVista">
        @if (mostrarActivos)
        {
            <span><i class="bi bi-archive me-2"></i> Consultar Archivo Muerto</span>
        }
        else
        {
            <span><i class="bi bi-check2-circle me-2"></i> Consultar Activos</span>
        }
    </button>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <QuickGrid Items="@listado" Pagination="@paginationState" Class="table mb-0 official-grid">
            <PropertyColumn Property="@(c => c.Nombre)" Sortable="true" Title="Nombre(s)" />
            <PropertyColumn Property="@(c => c.A_paterno)" Sortable="true" Title="Apellido Paterno" />
            <PropertyColumn Property="@(c => c.A_materno)" Sortable="true" Title="Apellido Materno" />
            <PropertyColumn Property="@(c => c.Telefono)" Sortable="true" Title="Teléfono" />
            <PropertyColumn Property="@(c => c.Matricula)" Sortable="true" Title="Matrícula" />
            <TemplateColumn Title="Gestión" Align="Align.Right">
                <div class="d-flex gap-2 justify-content-end">
                    @if (mostrarActivos)
                    {
                        <button class="btn btn-sm btn-link p-0 text-decoration-none" title="Editar Información" @onclick="() => AbrirModalEditar(context)">
                            <i class="bi bi-pencil-square fs-6"></i>
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-link p-0 text-decoration-none" title="Reincorporar" @onclick='() => CambiarEstado(context, "A")'>
                            <i class="bi bi-box-arrow-up fs-6"></i>
                        </button>
                    }
                    <button class="btn btn-sm btn-link p-0 m-0 text-decoration-none" title="Ver Detalles" @onclick="() => AbrirModalDetalle(context)">
                        <i class="bi bi-eye fs-6"></i>
                    </button>
                    @if (mostrarActivos)
                    {
                        <button class="btn btn-sm btn-link p-0 m-0 text-decoration-none text-danger" title="Dar de Baja" @onclick='() => CambiarEstado(context, "I")'>
                            <i class="bi bi-trash fs-6"></i>
                        </button>
                    }
                </div>
            </TemplateColumn>
        </QuickGrid>

        <div class="paginator-container p-2 border-top bg-light">
            <PaginadorEsp State="@paginationState" />
        </div>
    </div>
</div>

<SimpleModal Show="mostrarModal" Title="@tituloModal" OnCancel="CerrarModal" OnConfirm="GuardarPadron" HideSaveButton="@soloLectura">
    <fieldset disabled="@soloLectura" class="border-0 p-0 m-0">
        <div class="row g-3">
            @if (soloLectura)
            {
                <div class="col-12">
                    <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Matricula</label>
                    <input class="form-control lbl-required" @bind="registro.Matricula" />
                </div>
            }
            <div class="col-12">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Nombre(s)</label>
                <input class="form-control lbl-required" @bind="registro.Nombre" />
            </div>
            <div class="col-md-6">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Apellido Paterno</label>
                <input class="form-control" @bind="registro.A_paterno" />
            </div>
            <div class="col-md-6">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Apellido Materno</label>
                <input class="form-control" @bind="registro.A_materno" />
            </div>
            <div class="col-md-6">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">CURP</label>
                <input class="form-control" @bind="registro.Curp" />
            </div>
            <div class="col-md-6">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Dirección</label>
                <input class="form-control" @bind="registro.Direccion" />
            </div>

            @if (soloLectura && !string.IsNullOrWhiteSpace(registro.Matricula_anterior))
            {
                <div class="col-12">
                    <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Matricula Anterior</label>
                    <input class="form-control lbl-required" @bind="registro.Matricula" />
                </div>
            }
            <div class="col-12">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Gremio Asignado</label>
                <select class="form-select" @bind="registro.Id_gremio">
                    <option value="0">-- Seleccione un gremio --</option>
                    @if (gremios != null)
                    {
                        @foreach (var gremio in gremios)
                        {
                            <option value="@gremio.Id_gremio">@(gremio.Descripcion)</option>
                        }
                    }
                </select>
            </div>
            <div class="col-12">
                <label class="form-label small text-muted text-uppercase fw-bold lblwidth lbl-required">Tipo Vendedor</label>
                <select class="form-select" @bind="registro.Tipo_vendedor">
                    <option value="0">-- Seleccione un tipo --</option>
                    @if (tipos != null)
                    {
                        @foreach (var tipo in tipos)
                        {
                            <option value="@tipo.Id">@(tipo.Descripcion)</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label small text-muted text-uppercase fw-bold lbl-required">Teléfono</label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-telephone"></i></span>
                    <input class="form-control" @bind="registro.Telefono" placeholder="10 dígitos" />
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label small text-muted text-uppercase fw-bold">Correo Electrónico</label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-envelope"></i></span>
                    <input class="form-control" @bind="registro.Email" placeholder="oficial@dominio.gob" />
                </div>
            </div>
        </div>
    </fieldset>
</SimpleModal>

@code {
    // --- Datos ---
    private IQueryable<Padron>? listado;
    private IEnumerable<Gremio>? gremios;
    private class TipoOpcion { public string Id { get; set; } public string Descripcion { get; set; } }
    private bool mostrarActivos = true;
    private bool soloLectura = false; // Bandera para controlar el modo del modal
    private List<TipoOpcion> tipos = new()
    {
        new TipoOpcion { Id = "P", Descripcion = "Padron" },
        new TipoOpcion { Id = "E", Descripcion = "Eventual" }
    };
    private const string usuario = "Administrador";
    private PaginationState paginationState = new PaginationState { ItemsPerPage = 10 };

    // --- Modal ---
    private bool mostrarModal = false;
    private string tituloModal = "";

    // Inicialización segura
    private Padron registro = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await CargarDatos();
            await CargarGremios();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", $"Ocurrió un error al cargar la información: {ex.Message}", "error");
            return;
        }
    }

    private async Task CargarDatos()
    {
        var lista = await _padronService.GetAll();

        var filtrados = mostrarActivos
            ? lista.Where(c => c.Estado == "A")
            : lista.Where(c => c.Estado == "I");

        listado = filtrados.AsQueryable();
    }

    private async Task CargarGremios()
    {
        var lista = await _gremioService.GetAll();
        gremios = lista.Where(l => l.Estado == "A").ToList();
    }

    private async Task AlternarVista()
    {
        mostrarActivos = !mostrarActivos;
        try
        {
            await CargarDatos();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", $"Ocurrió un error al cargar la información: {ex.Message}", "error");
            return;
        }

    }

    // --- Lógica Modal ---
    private void AbrirModalCrear()
    {
        soloLectura = false;
        registro = new();
        tituloModal = "REGISTRO DE NUEVO VENDEDOR";
        mostrarModal = true;
    }

    private void AbrirModalEditar(Padron item)
    {
        soloLectura = false;
        // Clonación manual para edición segura
        registro = new()
        {
            Nombre = item.Nombre,
            A_paterno = item.A_paterno,
            A_materno = item.A_materno,
            Curp = item.Curp,
            Direccion = item.Direccion,
            Telefono = item.Telefono,
            Email = item.Email,
            Matricula = item.Matricula,
            Matricula_anterior = item.Matricula_anterior,
            Id_gremio = item.Id_gremio,
            Tipo_vendedor = item.Tipo_vendedor,
            Estado = item.Estado
        };
        tituloModal = "ACTUALIZACIÓN DE DATOS";
        mostrarModal = true;
    }

    private void AbrirModalDetalle(Padron item)
    {
        soloLectura = true;
        registro = item;
        tituloModal = "DETALLES DEL VENDEDOR";
        mostrarModal = true;
    }

    private void CerrarModal() => mostrarModal = false;

    private async Task GuardarPadron()
    {
        if (string.IsNullOrWhiteSpace(registro.Nombre) ||
        string.IsNullOrWhiteSpace(registro.A_paterno) ||
        string.IsNullOrWhiteSpace(registro.A_materno) ||
        string.IsNullOrWhiteSpace(registro.Curp) ||
        string.IsNullOrWhiteSpace(registro.Direccion) ||
        string.IsNullOrWhiteSpace(registro.Telefono))
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Atención", "Faltan datos obligatorios", "warning");
            return;
        }

        if (registro.Id_gremio == 0)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Atención", "Debe seleccionar un gremio", "warning");
            return;
        }

        if (registro.Tipo_vendedor == "0")
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Atención", "Debe seleccionar un tipo de vendedor", "warning");
            return;
        }

        try
        {
            if (registro.Id_padron == 0)
            {
                await _padronService.Create(
                    registro.Nombre, registro.A_paterno, registro.A_materno,
                    registro.Curp, registro.Direccion, registro.Telefono,
                    registro.Email, registro.Id_gremio, registro.Tipo_vendedor, usuario
                );
            }
            else
            {
                await _padronService.Update(
                    registro.Id_padron, registro.Nombre, registro.A_paterno,
                    registro.A_materno, registro.Curp, registro.Direccion, registro.Telefono,
                    registro.Email, registro.Matricula, registro.Matricula_anterior, registro.Id_gremio,
                    registro.Estado, usuario
                );
            }

            mostrarModal = false;

            await JSRuntime.InvokeVoidAsync("Swal.fire", new
            {
                title = "¡Éxito!",
                text = "La información se guardó correctamente.",
                icon = "success",
                confirmButtonColor = "#9D2449" 
            });

            await CargarDatos();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", $"Ocurrió un error al guardar la información: {ex.Message}", "error");
            return;
        }
    }

    // Método unificado para cambiar estado (Baja / Reincorporar)
    private async Task CambiarEstado(Padron item, string nuevoEstado)
    {
        try
        {
            // Solo llamamos al update cambiando el estado
            await _padronService.Update(
                item.Id_padron, item.Nombre, item.A_paterno,
                item.A_materno, item.Curp, item.Direccion, item.Telefono,
                item.Email, item.Matricula, item.Matricula_anterior, item.Id_gremio,
                nuevoEstado, usuario
            );

            await CargarDatos();

            // Mensaje dinámico según la acción
            var accion = nuevoEstado == "A" ? "reactivó" : "dio de baja";
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Éxito", $"El registro se {accion} correctamente.", "success");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", $"Ocurrió un error al actualizar el estado: {ex.Message}", "error");
        }
    }
}
