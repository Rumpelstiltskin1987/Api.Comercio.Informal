@page "/folios"
@using Api.Comercio.Informal.Components.Layout
@using Microsoft.AspNetCore.Components.QuickGrid
@using Api.Entities
@using Api.Business
@inject BusinessFolio _folioService
@inject AuthenticationStateProvider GetAuthenticationStateProvider
@attribute [Authorize(Roles = "Superadmin , Supervisor")]
@rendermode InteractiveServer

<link href="css/general.css" rel="stylesheet" />

<h3 class="mb-4 text-uppercase" style="color: #333; letter-spacing: 1px;">Catálogo de Folios</h3>
<hr />

<div class="d-flex justify-content-between mb-4 align-items-center">
    @* <button class="btn official-btn-primary btn-lg" @onclick="AbrirModalCrear">
        <i class="bi bi-plus-circle me-2"></i> Registrar Nuevo
    </button> *@

    <button class="btn official-btn-outline-secondary" @onclick="AlternarVista">
        @if (mostrarActivos)
        {
            <span><i class="bi bi-archive me-2"></i> Consultar Archivo Muerto</span>
        }
        else
        {
            <span><i class="bi bi-check2-circle me-2"></i> Consultar Activos</span>
        }
    </button>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        @if (listado == null)
        {
            <div class="p-5 text-center">
                <div class="spinner-border text-secondary" role="status"></div>
                <p class="mt-3 text-muted text-uppercase small">No existen registros en la base de datos...</p>
            </div>
        }
        else
        {
            <QuickGrid Items="@listado" Pagination="@paginationState" Class="table mb-0 official-grid">
                <PropertyColumn Property="@(c => c.Gremio.Descripcion)" Sortable="true" Title="Gremio" />
                <PropertyColumn Property="@(c => c.Prefijo)" Sortable="true" Title="Prefijo" />
                <PropertyColumn Property="@(c => c.Siguiente_folio)" Sortable="true" Title="Consecutivo" />
                <PropertyColumn Property="@(c => c.Anio_vigente)" Sortable="true" Title="Año Vigente" />
                <TemplateColumn Title="Folio" SortBy="@ordenFolio">
                    @($"{context.Prefijo}{(context.Anio_vigente % 100)}{context.Siguiente_folio:D6}")
                </TemplateColumn>
            </QuickGrid>

            <div class="paginator-container p-2 border-top bg-light">
                <PaginadorEsp State="@paginationState" />
            </div>
        }
    </div>
</div>

@code {
    // --- Datos ---
    private IQueryable<Folio>? listado;
    private PaginationState paginationState = new PaginationState { ItemsPerPage = 10 };
    private bool mostrarActivos = true;

    private static readonly GridSort<Folio> ordenFolio = GridSort<Folio>
        .ByAscending(x => x.Prefijo)
        .ThenAscending(x => x.Anio_vigente)
        .ThenAscending(x => x.Siguiente_folio);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar datos del padrón: {ex.Message}");
            listado = null;
        }
    }

    private async Task CargarDatos()
    {
        var lista = await _folioService.GetAll();
        var filtrados = mostrarActivos
            ? lista.Where(c => c.Anio_vigente == DateTime.Now.Year)
            : lista.Where(c => c.Anio_vigente < DateTime.Now.Year);

        listado = filtrados.AsQueryable();
    }

    private async Task AlternarVista()
    {
        mostrarActivos = !mostrarActivos;
        listado = null; // Reset visual para efecto de carga
        try
        {
            await CargarDatos();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar datos del padrón: {ex.Message}");
            listado = null;
        }
    }
}