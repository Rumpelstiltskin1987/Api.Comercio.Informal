@page "/cortedecaja"
@using Api.Comercio.Informal.Components.Layout
@using Api.Entities
@using Api.Entities.DTO
@using Api.Business
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using QuestPDF.Infrastructure
@inject IJSRuntime JSRuntime
@inject BusinessRecaudacion _recaudacionService
@inject BusinessUsuario _usuarioService
@inject AuthenticationStateProvider GetAuthenticationStateProvider
@attribute [Authorize(Roles = "Superadmin , Supervisor, Cobrador")]
@rendermode InteractiveServer

<h3 class="mb-4 text-uppercase" style="color: #333; letter-spacing: 1px;">Generar Corte de Caja</h3>
<hr />

<div class="no-print mb-4">
    <div class="card shadow-sm border-0">
        <div class="card-body bg-light">
            <div style="display: flex !important; flex-direction: row !important; flex-wrap: nowrap !important; align-items: flex-end; gap: 1rem; width: auto; ">

                @* SELECTOR DE COBRADOR *@
                <div style="width: auto; min-width: 160px; padding-bottom:12px; padding-left:10px;">
                    <label class="form-label fw-bold small text-uppercase mb-1">Cobrador</label>
                    <select class="form-select" @bind="idCobradorSeleccionado">
                        <option value="0">-- Seleccione --</option>
                        @foreach (var cob in cobradores)
                        {
                            <option value="@cob.Id">@cob.Nombre @cob.A_paterno</option>
                        }
                    </select>
                </div>

                @* FECHAS *@
                <div style="width: auto; min-width: 160px; padding-bottom:12px">
                    <label class="form-label fw-bold small text-uppercase mb-1">Fecha Inicio</label>
                    <input type="date" class="form-control" @bind="fechaInicio" />
                </div>

                <div style="width: auto; min-width: 160px; padding-bottom:12px">
                    <label class="form-label fw-bold small text-uppercase mb-1">Fecha Fin</label>
                    <input type="date" class="form-control" @bind="fechaFin" />
                </div>

                @* BOTÓN GENERAR *@
                <div style="width: auto; margin-bottom:7px">
                    <button class="btn official-btn-primary btn-lg" @onclick="GenerarCorte" disabled="@cargando">
                        @if (cargando)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        }
                        else
                        {
                            <span><i class="bi bi-search me-2"></i> Consultar</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@if (mostrarReporte && recaudacion != null && recaudacion.Any())
{
    <div class="reporte-wrapper mt-3">
        <div class="hoja-reporte">

            @* BARRA DE ACCIONES *@
            <div class="d-flex justify-content-end mb-3 no-print gap-2">
                @* Botón IMPRIMIR (Navegador) *@
                <button class="btn btn-outline-secondary btn-sm" @onclick="Imprimir">
                    <i class="bi bi-printer me-2"></i> Vista Previa
                </button>

                @* Botón PDF (QuestPDF) *@
                <button class="btn btn-danger btn-sm" @onclick="DescargarPDF">
                    <i class="bi bi-file-earmark-pdf-fill me-2"></i> Descargar PDF Oficial
                </button>
            </div>

            @* VISTA PREVIA HTML (Lo que se ve en pantalla) *@
            <div class="text-center">
                <h5 class="text-uppercase fw-bold mb-0">H. Ayuntamiento Constitucional de Tierra Blanca, Veracruz.</h5>
                <h6 class="fw-light mb-0">Tesorería Municipal - Dirección de Comercio</h6>
                <hr class="separador-institucional" />
                <h3 class="mt-2 fw-bold text-uppercase">Corte de Caja General</h3>

                <div class="row mt-4 mb-4 small text-muted text-uppercase border-bottom pb-3">
                    <div class="col-6 text-start">
                        <p class="mb-1"><strong>Cobrador:</strong> <span class="text-dark">@NombreCobradorSeleccionado()</span></p>
                    </div>
                    <div class="col-6 text-end">
                        <p class="mb-1"><strong>Periodo:</strong> @fechaInicio.ToString("dd/MM/yyyy") - @fechaFin.ToString("dd/MM/yyyy")</p>
                    </div>
                </div>

                <table class="table table-sm table-striped text-start small">
                    <thead class="table-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>Folio</th>
                            <th>Contribuyente</th>
                            <th class="text-end">Importe</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in recaudacion)
                        {
                            <tr>
                                <td>@item.Fecha_cobro.ToString("dd/MM/yyyy")</td>
                                <td>@item.Folio_Recibo</td>
                                <td>@item.Padron.Telefono</td>
                                <td class="text-end">@item.Monto.ToString("C2")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr class="fw-bold fs-6">
                            <td colspan="3" class="text-end">TOTAL RECAUDADO:</td>
                            <td class="text-end">@recaudacion.Sum(x => x.Monto).ToString("C2")</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
}
else if (mostrarReporte && (recaudacion == null || !recaudacion.Any()))
{
    <div class="alert alert-warning text-center">
        No se encontraron registros para el rango de fechas y cobrador seleccionados.
    </div>
}

@code {
    // TUS VARIABLES
    private DateTime fechaInicio = DateTime.Today;
    private DateTime fechaFin = DateTime.Today;
    private int idCobradorSeleccionado = 0;
    private bool cargando = false;
    private bool mostrarReporte = false;

    // LISTAS
    private IEnumerable<DtoUsuario> cobradores = new List<DtoUsuario>();
    private List<Recaudacion> recaudacion = new(); 

    protected override async Task OnInitializedAsync()
    {
        // Configurar licencia Community de QuestPDF (Obligatorio)
        QuestPDF.Settings.License = LicenseType.Community;
        await CargarCobradores();
    }


    private async Task CargarCobradores()
    {
        try
        {
            var usuariosdb = await _usuarioService.GetByRol("Cobrador");
            cobradores = usuariosdb.Select(u => new DtoUsuario
            {
                Id = u.Id,
                Nombre = u.Nombre,
                A_paterno = u.A_paterno,
                A_materno = u.A_materno
            }).ToList();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", ex.Message, "error");
        }
    }

    private async Task GenerarCorte()
    {
        if (idCobradorSeleccionado <= 0)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Atención", "Seleccione un cobrador", "warning");
            return;
        }

        cargando = true;
        mostrarReporte = false;
        try
        {
            // LLAMADA A TU SERVICIO REAL
            recaudacion = (await _recaudacionService.Search(idCobradorSeleccionado, null, fechaInicio, fechaFin)).ToList();
            mostrarReporte = true;
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", ex.Message, "error");
        }
        finally
        {
            cargando = false;
        }
    }

    private string NombreCobradorSeleccionado()
    {
        var cob = cobradores.FirstOrDefault(c => c.Id == idCobradorSeleccionado);
        return cob != null ? $"{cob.Nombre} {cob.A_paterno}" : "Desconocido";
    }

    private async Task Imprimir()
    {
        await JSRuntime.InvokeVoidAsync("print");
    }

    // --- LÓGICA DE GENERACIÓN DE PDF (QUESTPDF) ---
    private async Task DescargarPDF()
    {
        try
        {
            // 1. Crear el documento
            var documento = Document.Create(container =>
            {
                container.Page(page =>
                {
                    page.Size(PageSizes.Letter);
                    page.Margin(2, Unit.Centimetre);
                    page.PageColor(Colors.White);
                    page.DefaultTextStyle(x => x.FontSize(10));

                    // ENCABEZADO
                    page.Header().Row(row =>
                    {
                        row.RelativeItem().Column(col =>
                        {
                            col.Item().Text("H. AYUNTAMIENTO CONSTITUCIONAL").Bold().FontSize(14);
                            col.Item().Text("TESORERÍA MUNICIPAL - TIERRA BLANCA, VER.").FontSize(10);
                            col.Item().Text($"Corte de Caja: {NombreCobradorSeleccionado()}").FontSize(12).SemiBold().FontColor(Colors.Grey.Darken2);
                            col.Item().Text($"Periodo: {fechaInicio:dd/MM/yyyy} al {fechaFin:dd/MM/yyyy}");
                        });

                        // Si tienes un logo en wwwroot/img/logo.png, descomenta esto:
                        // row.ConstantItem(60).Image("wwwroot/img/escudo_armas.jpg");
                    });

                    // CONTENIDO
                    page.Content().PaddingVertical(1, Unit.Centimetre).Table(table =>
                    {
                        // Definir columnas
                        table.ColumnsDefinition(columns =>
                        {
                            columns.ConstantColumn(80); // Fecha
                            columns.ConstantColumn(60); // Folio
                            columns.RelativeColumn();   // Contribuyente (se expande)
                            columns.ConstantColumn(80); // Importe
                        });

                        // Encabezados de tabla
                        table.Header(header =>
                        {
                            header.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten1).Padding(2).Text("FECHA").Bold();
                            header.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten1).Padding(2).Text("FOLIO").Bold();
                            header.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten1).Padding(2).Text("CONTRIBUYENTE").Bold();
                            header.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten1).Padding(2).AlignRight().Text("IMPORTE").Bold();
                        });

                        // Filas de datos
                        foreach (var item in recaudacion)
                        {
                            table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten3).Padding(2).Text(item.Fecha_cobro.ToString("dd/MM/yyyy"));
                            table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten3).Padding(2).Text(item.Folio_Recibo.ToString());
                            table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten3).Padding(2).Text(item.Padron.Nombre);
                            table.Cell().BorderBottom(1).BorderColor(Colors.Grey.Lighten3).Padding(2).AlignRight().Text(item.Monto.ToString("C2"));
                        }

                        // Total
                        table.Footer(footer =>
                        {
                            footer.Cell().ColumnSpan(3).Padding(5).AlignRight().Text("TOTAL RECAUDADO:").Bold();
                            footer.Cell().Padding(5).AlignRight().Text(recaudacion.Sum(x => (decimal)x.Monto).ToString("C2")).Bold().FontSize(11);
                        });
                    });

                    // PIE DE PÁGINA
                    page.Footer().AlignCenter().Text(x =>
                    {
                        x.Span("Página ");
                        x.CurrentPageNumber();
                    });
                });
            });

            // 2. Generar bytes
            var pdfBytes = documento.GeneratePdf();

            // 3. Enviar al navegador
            using var stream = new MemoryStream(pdfBytes);
            using var streamRef = new DotNetStreamReference(stream);
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", $"Corte_{fechaInicio:yyyyMMdd}.pdf", streamRef);

        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error al generar PDF", ex.Message, "error");
        }
    }
}